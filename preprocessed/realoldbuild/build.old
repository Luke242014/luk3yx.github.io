#!/bin/bash
# Simple template builder
# Copyrigt 2016 by luk3yx.
# All rights reserved.
(
sleep 0.3
echo "# Loading..."

DIR=$(pwd)
template="./template.html"
stemplate="./template.slim"
alldir="./html"
alldir=$(readlink -m "$alldir")

function build {
    echo "# Building $in..."
    out="../$in"
    in="./html/$in"
    
    in=$(readlink -m "$in")
    template=$(readlink -m "$template")
    out=$(readlink -m "$out")
    
    indent="        "
    string="$indent<h1>Don't edit me. I help the auto-generator.</h1>"
    
    function hit {
        while IFS='' read -r line; do
            echo "$indent$line" >> "$out"
        done < "$in"
    }
    
    rm "$out"
    year=$(date +%Y)
    date="Last modification date: "$(date -u)'<br/>'
    while IFS='' read -r line; do
        if [ "$line" = "$string" ]; then
            hit
        else
            pline="${line//<!--YEAR -->/$year }"
            pline="${pline//<!--DATE-->/$date}"
            echo "$pline" >> "$out"
        fi
    done < "$template"
    showprog
}

cd "$alldir"
files=(*)
cd "$DIR"
int="${#files[@]}"
let int=100/int
c=0
function showprog {
    let c=c+1
    let int2=int*c
    [ "$int2" -ge "100" ] && int2=99
    echo "$int2"
}
echo -n "# Building SLIM template..."
rm "$stemplate"
while IFS='' read -r line; do
    case "$line" in
        *"<h1>Don't edit me. I help the auto-generator.</h1>"*)
        echo "."
        cline='== content'
        ;;
        *)
        cline="| $line"
        ;;
    esac
    echo "$cline" >> "$stemplate"
done <"$template"
showprog
echo "# Loading..."

for i in "${files[@]}"; do
    in="$i"
    build
done
echo "# Done!"
echo 100
exit
) | zenity                              \
    --progress                          \
    --title "Simple Template Builder"   \
    --text "Building..."                \
    --width 400 --height 400            \
    --auto-close --auto-kill
